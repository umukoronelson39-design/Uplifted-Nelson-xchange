<script>
    Backendless.initApp("EAE10E02-8554-43FA-A445-17B496B2F52E", "7905FB19-9C35-4313-976B-1AE613B9A276");

    let userEmail = "";

    function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        Backendless.UserService.login(email, password, true)
            .then(user => {
                userEmail = user.email;
                document.getElementById("auth-screen").style.display = "none";
                document.getElementById("dashboard-screen").style.display = "block";
                document.getElementById("user-email-display").innerText = user.email;
                updateBalanceDisplay(user.balance);
                refreshHistory();
                setInterval(refreshHistory, 30000);
            }).catch(err => alert(err.message));
    }

    function updateBalanceDisplay(amt) {
        document.getElementById("balance-display").innerText = "$" + (amt || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
    }

    function toggleUpload() {
        document.getElementById("upload-container").style.display = document.getElementById("trade-category").value === "Giftcard" ? "block" : "none";
    }

    async function submitTrade() {
        const asset = document.getElementById("asset-name").value;
        const amount = document.getElementById("trade-amount").value;
        const fileInput = document.getElementById("card-image");
        if(!asset || !amount) return alert("Please fill all fields");

        let fileUrl = "";
        try {
            if (fileInput.files.length > 0) {
                const uploaded = await Backendless.Files.upload(fileInput.files[0], "trades", true);
                fileUrl = uploaded.fileURL;
            }

            const trade = {
                category: document.getElementById("trade-category").value,
                asset: asset,
                amount: Number(amount),
                status: "Pending",
                userEmail: userEmail,
                proofImage: fileUrl,
                paidOut: false // This sets it correctly in the DB
            };

            await Backendless.Data.of("Trades").save(trade);
            alert("Trade Sent Successfully!");
            refreshHistory();
        } catch (err) { alert("Upload failed: " + err.message); }
    }

    function refreshHistory() {
        if(!userEmail) return;
        // Simplified query to ensure all trades for this user show up
        const query = Backendless.DataQueryBuilder.create()
            .setWhereClause(`userEmail = '${userEmail}'`)
            .setSortBy(["created DESC"]);

        Backendless.Data.of("Trades").find(query).then(trades => {
            const tbody = document.getElementById("history-body");
            tbody.innerHTML = "";
            
            if (trades.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px; color:#999;'>No trades yet</td></tr>";
            }

            trades.forEach(t => {
                // Auto-payout if YOU marked it Completed and it's not yet paid out
                if (t.status === "Completed" && t.paidOut !== true) { 
                    processPayout(t); 
                }

                // Show Delete button for finished trades, otherwise show a lock
                const isFinished = (t.status === "Completed" || t.status === "Rejected");
                const actionContent = isFinished 
                    ? `<button onclick="deleteTrade('${t.objectId}')" style="background:none; border:none; color:red; font-size:16px;">Delete</button>` 
                    : `<span style="font-size:16px;">ðŸ”’</span>`;

                tbody.innerHTML += `<tr>
                    <td>${t.asset || '---'}</td>
                    <td>$${t.amount || 0}</td>
                    <td class="status-${(t.status || 'pending').toLowerCase()}">${t.status || 'Pending'}</td>
                    <td style="text-align:center">${actionContent}</td>
                </tr>`;
            });
        }).catch(err => console.log("History Error:", err));
    }

    function deleteTrade(id) {
        if (confirm("Permanently delete this trade from your history?")) {
            Backendless.Data.of("Trades").remove({ objectId: id })
                .then(() => refreshHistory())
                .catch(err => alert("Delete failed: " + err.message));
        }
    }

    function processPayout(trade) {
        Backendless.UserService.getCurrentUser().then(user => {
            const currentBal = user.balance || 0;
            user.balance = currentBal + trade.amount;
            
            Backendless.UserService.update(user).then(updatedUser => {
                trade.paidOut = true;
                Backendless.Data.of("Trades").save(trade); // Mark as paid so it doesn't repeat
                updateBalanceDisplay(updatedUser.balance);
            });
        });
    }
</script>
