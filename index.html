<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nelson Xchange | Premium OTC</title>
<script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
--primary:#4338ca;--success:#059669;--warning:#d97706;--danger:#dc2626;
--bg:#f8fafc;--card:#ffffff;--text-main:#1e293b;--text-muted:#64748b;
}
body{font-family:Inter;background:var(--bg);margin:0;display:flex;flex-direction:column;align-items:center}
.container{max-width:440px;width:100%;padding:20px}
.box{background:#fff;padding:30px;border-radius:24px;box-shadow:0 10px 20px rgba(0,0,0,.05);text-align:center}
input,select,textarea{width:100%;padding:14px;margin:8px 0;border-radius:12px;border:1px solid #e2e8f0}
button{padding:14px;border:none;border-radius:12px;font-weight:700;cursor:pointer}
.login-btn,.trade-btn{background:var(--primary);color:#fff}
.withdraw-btn{background:var(--success);color:#fff}
.wallet-card{background:linear-gradient(135deg,#4338ca,#6366f1);color:#fff;padding:22px;border-radius:20px;margin:20px 0;text-align:left}
.status-badge{font-size:11px;font-weight:700;padding:4px 8px;border-radius:6px}
.status-pending{background:#fffbeb;color:var(--warning)}
.status-completed{background:#ecfdf5;color:var(--success)}
.status-rejected{background:#fef2f2;color:var(--danger)}
.whatsapp-link{background:#25D366;color:white;text-decoration:none;display:block;padding:14px;border-radius:12px;margin-top:20px}
</style>
</head>

<body>
<div class="container">

<div id="auth-screen" class="box">
<h2>Nelson Xchange</h2>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button class="login-btn" onclick="login()">Login</button>
</div>

<div id="dashboard-screen" class="box" style="display:none">

<div class="wallet-card" onclick="refreshHistory()">
<p>AVAILABLE BALANCE</p>
<h1 id="balance-display">$0.00</h1>
</div>

<h3>New Trade</h3>
<input id="asset-name" placeholder="Asset name">
<input id="trade-amount" type="number" placeholder="Amount USD">
<button class="trade-btn" onclick="submitTrade()">Submit Trade</button>

<h3>Trades</h3>
<table width="100%">
<tbody id="trade-history-body"></tbody>
</table>

<h3>Withdraw</h3>
<input id="withdraw-amount" type="number" placeholder="Amount">
<textarea id="withdraw-details" placeholder="Bank details"></textarea>
<button class="withdraw-btn" onclick="submitWithdrawal()">Withdraw</button>

<table width="100%">
<tbody id="withdraw-history-body"></tbody>
</table>

<a href="https://wa.me/2348174027335?text=Hello%20Nelson%20Xchange" class="whatsapp-link">
Chat Support
</a>

</div>
</div>

<script>
Backendless.initApp(
"EAE10E02-8554-43FA-A445-17B496B2F52E",
"7905FB19-9C35-4313-976B-1AE613B9A276"
);

let userEmail="";
let currentBalance=0;

function login(){
Backendless.UserService.login(
document.getElementById("email").value,
document.getElementById("password").value,
true
).then(user=>{
userEmail=user.email;
currentBalance=Number(user.balance||0);
document.getElementById("auth-screen").style.display="none";
document.getElementById("dashboard-screen").style.display="block";
updateBalanceDisplay(currentBalance);
refreshHistory();
setInterval(refreshHistory,10000);
}).catch(err=>alert(err.message));
}

function updateBalanceDisplay(amt){
document.getElementById("balance-display").innerText=
"$"+Number(amt).toLocaleString(undefined,{minimumFractionDigits:2});
}

function submitTrade(){
const asset=document.getElementById("asset-name").value;
const amt=Number(document.getElementById("trade-amount").value);
if(!asset||amt<=0)return alert("Enter details");

Backendless.Data.of("Trades").save({
asset:asset,
amount:amt,
status:"Pending",
userEmail:userEmail,
paidOut:false
}).then(()=>{alert("Trade sent");refreshHistory()});
}

async function submitWithdrawal(){
const amt=Number(document.getElementById("withdraw-amount").value);
const details=document.getElementById("withdraw-details").value;

if(amt<=0||amt>currentBalance)return alert("Invalid amount");

const user=await Backendless.UserService.getCurrentUser();
user.balance=currentBalance-amt;

await Backendless.UserService.update(user);
updateBalanceDisplay(user.balance);

await Backendless.Data.of("Withdrawals").save({
amount:amt,
details:details,
method:"Withdrawal",
userEmail:userEmail,
status:"Pending"
});

alert("Withdrawal submitted");
refreshHistory();
}

function refreshHistory(){
if(!userEmail)return;

const q=Backendless.DataQueryBuilder.create()
.setWhereClause(`userEmail='${userEmail}'`)
.setSortBy(["created DESC"]);

Backendless.Data.of("Trades").find(q).then(list=>{
const body=document.getElementById("trade-history-body");
body.innerHTML="";
list.forEach(t=>{
const amt=Number(t.amount||0);
const stat=(t.status||"pending").toLowerCase().trim();
const paid=t.paidOut||false;

if(stat==="completed" && paid===false){
processPayout(t,amt);
}

body.innerHTML+=`
<tr>
<td>${t.asset}</td>
<td>$${amt.toLocaleString()}</td>
<td><span class="status-badge status-${stat}">${stat}</span></td>
</tr>`;
});
});

Backendless.Data.of("Withdrawals").find(q).then(list=>{
const body=document.getElementById("withdraw-history-body");
body.innerHTML="";
list.forEach(w=>{
body.innerHTML+=`
<tr>
<td>${w.method}</td>
<td>$${w.amount}</td>
<td><span class="status-badge status-${w.status.toLowerCase()}">${w.status}</span></td>
</tr>`;
});
});
}

function processPayout(trade,amt){
Backendless.UserService.getCurrentUser().then(user=>{
const start=Number(user.balance||0);
user.balance=start+Number(amt);

Backendless.UserService.update(user).then(updated=>{
trade.paidOut=true;
Backendless.Data.of("Trades").save(trade);
updateBalanceDisplay(updated.balance);
});
});
}
</script>
</body>
</html>